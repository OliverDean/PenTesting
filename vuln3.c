#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>

// Function to simulate a random delay
void random_delay() {
    // Random delay between 0 and 1 second
    int delay = rand() % 2; 
    sleep(delay); // Introduce the delay
}

// Function to generate the correct password
const char* get_password() {
    static char pw[9]; // Size 9 for "UWA4Life" + null terminator
    pw[0] = 'U' ^ 0xFF; // XOR transformation to obfuscate
    pw[1] = 'W' ^ 0xFF;
    pw[2] = 'A' ^ 0xFF;
    pw[3] = '4' ^ 0xFF;
    pw[4] = 'L' ^ 0xFF;
    pw[5] = 'i' ^ 0xFF;
    pw[6] = 'f' ^ 0xFF;
    pw[7] = 'e' ^ 0xFF;
    pw[8] = '\0'; // Null-terminate the string
    return pw; // Return the obfuscated password
}

// Function to compare characters with timing vulnerability
int compare_chars(char a, char b) {
    // Introduce delay only if the characters are the same
    if (a == b) {
        random_delay(); // Delay on successful match
    }
    return a == b;
}

// Function to execute the password check
void check_password(const char *input) {
    const char *password = get_password(); // Get the obfuscated password
    size_t len = strlen(password);
    int match = 1; // Assume match is true initially

    // Obfuscated loop structure
    for (size_t i = 0; i < len; i++) {
        char obfuscated_char = password[i] ^ 0xFF; // Reverse the obfuscation
        if (!compare_chars(input[i], obfuscated_char)) {
            match = 0; // Set match to false if any character doesn't match
            break; // Exit the loop early
        }
    }

    // Print the result based on the match status
    if (match) {
        printf("Password is correct!\n");
    } else {
        printf("Invalid password!\n");
    }
}

// Anti-debugging measures using system calls
void anti_debugging() {
    if (getppid() == 1) { // Check if the parent process is init (indicates a debugger)
        printf("Debugging detected! Exiting...\n");
        exit(1);
    }
}

// Main function
int main() {
    char input[50];

    // Seed the random number generator
    srand(time(NULL));

    // Call anti-debugging function
    anti_debugging();

    // Prompt user for password
    printf("Enter password: ");
    fgets(input, sizeof(input), stdin);
    // Remove newline character if present
    input[strcspn(input, "\n")] = 0;

    // Call the password checking function
    check_password(input);

    return 0;
}
