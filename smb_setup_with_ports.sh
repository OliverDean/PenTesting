#!/bin/bash

# Define the Samba user and twisted cipher file location
REAL_USER="user1"
TWISTED_CIPHER_FILE="/srv/samba/sensitive_information/twistedcipher.txt"
SAMBA_CONF="/etc/samba/smb.conf"

# Define directories for the two shares
DECOY_DIR="/srv/samba/sensitive_information"
REAL_DIR="/srv/samba/vulnerable_share"

# Define directories for the nested structure
DIR1="$REAL_DIR/dir1"
DIR2="$DIR1/dir2"
DIR3="$DIR2/dir3"
FLAG_FILE="$DIR3/flag.txt"

# Generate random ports for the decoy and real shares (restricted to 1025-6000)
DECOY_PORT=$((1025 + RANDOM % 4975))
REAL_PORT=$((1025 + RANDOM % 4975))

# Function to check if a package is installed, if not, install it
check_and_install() {
    PACKAGE=$1
    if dpkg -s "$PACKAGE" >/dev/null 2>&1; then
        echo "$PACKAGE is already installed."
    else
        echo "Installing $PACKAGE..."
        sudo apt-get install -y "$PACKAGE"
    fi
}

# Function to generate a random password (6 characters)
generate_password() {
    # Generate a random password of 6 characters (alphanumeric)
    echo $(tr -dc A-Za-z0-9 </dev/urandom | head -c 6)
}

# Function to apply a Caesar cipher rotation to the password
rotate_password() {
    local password="$1"
    local rotation=$(($RANDOM % 25 + 1))  # Rotation between 1 and 25

    # Create rotated alphabet by shifting A-Z and a-z
    UPPER_ALPHABET=$(echo {A..Z} | tr -d ' ')
    LOWER_ALPHABET=$(echo {a..z} | tr -d ' ')
    ROTATED_UPPER_ALPHABET=$(echo "$UPPER_ALPHABET" | sed "s/^\(.\{$rotation\}\)\(.*\)/\2\1/")
    ROTATED_LOWER_ALPHABET=$(echo "$LOWER_ALPHABET" | sed "s/^\(.\{$rotation\}\)\(.*\)/\2\1/")

    # Rotate the password by replacing the original characters with the rotated ones
    echo "$password" | tr "$UPPER_ALPHABET$LOWER_ALPHABET" "$ROTATED_UPPER_ALPHABET$ROTATED_LOWER_ALPHABET"
}

# Function to create directory structure and flag.txt file
create_nested_directories() {
    # Create nested directories inside vulnerable_share
    echo "Creating nested directories inside $REAL_DIR..."
    sudo mkdir -p "$DIR3"

    # Update the flag.txt file with new content
    echo "FLAG{knock700080009000}" | sudo tee "$FLAG_FILE" > /dev/null

    # Set appropriate permissions for the directories and file
    sudo chmod 755 "$DIR1" "$DIR2" "$DIR3"
    sudo chmod 644 "$FLAG_FILE"
    echo "Flag file created at: $FLAG_FILE"
}

# Function to update the Samba password and store the rotated password
update_samba_password() {
    # Generate a random password
    NEW_PASSWORD=$(generate_password)

    # Rotate the password using Caesar cipher
    ROTATED_PASSWORD=$(rotate_password "$NEW_PASSWORD")

    # Store the rotated password in the twistedcipher.txt file
    echo "Rotated password: $ROTATED_PASSWORD"
    echo "$ROTATED_PASSWORD" > "$TWISTED_CIPHER_FILE"

    # Print the random password and rotated password
    echo "Random password: $NEW_PASSWORD"
    echo "Rotated password: $ROTATED_PASSWORD"

    # Update the Samba password for the user (no prompt)
    (echo "$NEW_PASSWORD"; echo "$NEW_PASSWORD") | smbpasswd -s "$REAL_USER"

    echo "Updated Samba password for $REAL_USER"
}

# Function to rotate the password every 30 minutes
rotate_every_thirty_minutes() {
    while true; do
        update_samba_password
        echo "Next password update in 30 minutes..."
        sleep 1800  # Sleep for 30 minutes (1800 seconds)
    done
}

# Remove existing [global] section and any duplicate share configurations
clean_samba_conf() {
    # Remove the [global] section and all its parameters
    echo "Removing existing [global] section..."
    sudo sed -i '/\[global\]/,/^\[/d' "$SAMBA_CONF"

    # Remove any duplicate [vulnerable_share] section
    if grep -q "\[vulnerable_share\]" "$SAMBA_CONF"; then
        echo "Removing duplicate [vulnerable_share] sections..."
        sudo sed -i '/\[vulnerable_share\]/,/^$/d' "$SAMBA_CONF"
    fi

    # Remove any duplicate [sensitive_information] section
    if grep -q "\[sensitive_information\]" "$SAMBA_CONF"; then
        echo "Removing duplicate [sensitive_information] sections..."
        sudo sed -i '/\[sensitive_information\]/,/^$/d' "$SAMBA_CONF"
    fi
}

# Add the new configuration to smb.conf
configure_samba_shares() {
    echo "Configuring Samba for two shares on random ports..."
    sudo bash -c "cat > $SAMBA_CONF" <<EOL
[global]
smb ports = $DECOY_PORT $REAL_PORT

[sensitive_information]
path = $DECOY_DIR
browseable = yes
writable = no
guest ok = yes

[vulnerable_share]
path = $REAL_DIR
browseable = yes
writable = yes
guest ok = no
valid users = $REAL_USER
EOL
}

# Backup the original Samba configuration if not already backed up
backup_samba_conf() {
    local backup_conf="/etc/samba/smb.conf.bak"
    if [ ! -f "$backup_conf" ]; then
        echo "Backing up the original Samba configuration to $backup_conf"
        sudo cp "$SAMBA_CONF" "$backup_conf"
    else
        echo "Backup of Samba configuration already exists."
    fi
}

# Configure UFW to allow the necessary ports
configure_ufw() {
    echo "Removing old UFW rules for previous SMB ports..."
    for rule in $(sudo ufw status | grep 'ALLOW' | grep 'tcp' | awk '{print $1}' | sort -u); do
        echo "Removing UFW rule for $rule"
        sudo ufw delete allow $rule
    done

    # Allow the new Samba ports (restricted to ports <= 6000)
    echo "Allowing SMB traffic on ports $DECOY_PORT and $REAL_PORT..."
    sudo ufw allow "$DECOY_PORT/tcp"
    sudo ufw allow "$REAL_PORT/tcp"
    sudo ufw reload
}

# Start the Samba service
restart_samba_service() {
    echo "Restarting Samba service..."
    sudo systemctl restart smbd
    sudo systemctl restart nmbd
}

# Main function to set up everything and rotate the password
main() {
    backup_samba_conf
    clean_samba_conf
    configure_samba_shares
    configure_ufw
    restart_samba_service
    create_nested_directories
    rotate_every_thirty_minutes  # Rotate password every 30 minutes
}

# Run the main function
main
